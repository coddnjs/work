<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ê·¼ë¬´ ê¸°ë¡</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="wrap">

  <header class="topbar">
    <div>
      <h1>ê·¼ë¬´ ê¸°ë¡</h1>
      <p class="lead">ì¶œê·¼Â·í‡´ê·¼ ì‹œê°„ì„ ì…ë ¥í•˜ë©´ ìë™ìœ¼ë¡œ ê·¼ë¬´ì‹œê°„ì´ ê³„ì‚°ë©ë‹ˆë‹¤.</p>
    </div>

    <div class="month-nav">
      <button id="prevMonth" class="nav-btn">â—€</button>
      <div id="monthTitle" class="month-label"></div>
      <button id="nextMonth" class="nav-btn">â–¶</button>
    </div>
  </header>

  <main class="grid">
    <!-- ìº˜ë¦°ë” -->
    <section>
      <div class="cal-card">
        <div class="weekday-row">
          <div>ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div>í† </div>
        </div>
        <div id="calendar" class="days-grid"></div>
        <div id="selectedEntry" class="selected-entry"></div>
      </div>
    </section>

    <!-- ì˜¤ë¥¸ìª½ ì…ë ¥ UI -->
    <aside class="panel">
      <div class="card">
        <h3>ê¸°ë¡</h3>
        <div class="selected-date" id="selectedDateBox">ì„ íƒëœ ë‚ ì§œ ì—†ìŒ</div>

        <div class="field">
          <label>ì¶œê·¼</label>
          <input type="text" id="startTime" placeholder="ì˜ˆ: 090000">
        </div>
        <div class="field">
          <label>í‡´ê·¼</label>
          <input type="text" id="endTime" placeholder="ì˜ˆ: 180000">
        </div>
        <div class="field checkbox">
          <label for="breakCheck">ì™¸ì¶œ</label>
          <label class="toggle">
            <input type="checkbox" id="breakCheck">
            <span class="slider"></span>
          </label>
        </div>
        <div class="field" id="breakInputWrap" style="display:none;">
          <label>ì™¸ì¶œ ì‹œê°„</label>
          <input type="text" id="breakTime" placeholder="ì˜ˆ: 003000">
        </div>
        <div class="field">
          <label>ë©”ëª¨</label>
          <textarea id="memo" placeholder="ë©”ëª¨ (ì„ íƒ)"></textarea>
        </div>

        <div class="controls">
          <button id="save" class="btn-primary">ì €ì¥</button>
          <button id="delete" class="btn-ghost">ì‚­ì œ</button>
        </div>

        <div class="foot-note"> ì…ë ¥ ì˜ˆì‹œ: 093000, 18:20:55 ë“± ëª¨ë‘ ê°€ëŠ¥ </div>
      </div>

      <div class="card">
        <h3>ì´ë²ˆ ë‹¬ ì´ ê·¼ë¬´ì‹œê°„</h3>
        <div id="monthTotal" class="month-total">00:00:00</div>
      </div>
    </aside>
  </main>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

// Firebase ì„¤ì •
const firebaseConfig = {
  apiKey: "AIzaSyCoMSY3XNJJ9jmemad545ugFVrfAM0T07M",
  authDomain: "work-3aad3.firebaseapp.com",
  projectId: "work-3aad3",
  storageBucket: "work-3aad3.firebasestorage.app",
  messagingSenderId: "225615907016",
  appId: "1:225615907016:web:b9ccbe8331df644aa73dfd"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// DOM
const calendar = document.getElementById("calendar");
const monthTitle = document.getElementById("monthTitle");
const selectedBox = document.getElementById("selectedDateBox");
const startInput = document.getElementById("startTime");
const endInput = document.getElementById("endTime");
const breakInput = document.getElementById("breakTime");
const breakCheck = document.getElementById("breakCheck");
const breakWrap = document.getElementById("breakInputWrap");
const memoInput = document.getElementById("memo");
const saveBtn = document.getElementById("save");
const monthTotal = document.getElementById("monthTotal");

let current = new Date();
let selected = new Date();

// ìœ í‹¸
function pad(n){ return String(n).padStart(2,"0"); }
function format(sec){
  const h=Math.floor(sec/3600);
  const m=Math.floor((sec%3600)/60);
  const s=sec%60;
  return `${pad(h)}:${pad(m)}:${pad(s)}`;
}
function parse(t){
  if(!t) return 0;
  t=t.replace(/[^0-9:]/g,"").trim();
  if(t.includes(":")){
    const [h,m,s]=t.split(":").map(Number);
    return h*3600+m*60+(s||0);
  }
  t=t.padStart(6,"0");
  return Number(t.slice(0,2))*3600 + Number(t.slice(2,4))*60 + Number(t.slice(4,6));
}

// Firestore ì ‘ê·¼ í•¨ìˆ˜
async function loadDayData(date){
  const iso = date.toISOString().slice(0,10);
  try{
    const snap = await getDoc(doc(db,"worklog",iso));
    return snap.exists() ? snap.data() : null;
  } catch(e){
    console.error("Firestore ì ‘ê·¼ ì‹¤íŒ¨:", e);
    return null;
  }
}

async function selectDate(d){
  selected = d;
  selectedBox.textContent = selected.toISOString().slice(0,10);

  const dbData = await loadDayData(selected);
  startInput.value = dbData?.start || "";
  endInput.value = dbData?.end || "";
  memoInput.value = dbData?.memo || "";
  if(dbData?.break){
    breakCheck.checked = true;
    breakWrap.style.display = "block";
    breakInput.value = dbData.break;
  } else {
    breakCheck.checked = false;
    breakWrap.style.display = "none";
    breakInput.value = "";
  }

  renderCalendar();
  renderSelected();
}

function renderSelected(){
  const iso = selected.toISOString().slice(0,10);
  const box = document.getElementById("selectedEntry");
  loadDayData(selected).then(db=>{
    if(!db){
      box.innerHTML = `<div class="entry-card record-none">ê¸°ë¡ ì—†ìŒ</div>`;
      return;
    }
    box.innerHTML = `
      <div class="entry-card">
        <div class="entry-time">${iso} (${db.time})</div>
        <div class="entry-memo">${db.memo||""}</div>
      </div>
    `;
  });
}

async function renderCalendar(){
  calendar.innerHTML="";
  const y=current.getFullYear();
  const m=current.getMonth();
  monthTitle.textContent=`${y}ë…„ ${m+1}ì›”`;

  const first=new Date(y,m,1).getDay();
  const last=new Date(y,m+1,0).getDate();

  for(let i=0;i<first;i++) calendar.appendChild(document.createElement("div"));

  for(let d=1; d<=last; d++){
    const iso=`${y}-${pad(m+1)}-${pad(d)}`;
    const box=document.createElement("div");
    box.className="day";
    box.innerHTML=`<span>${d}</span>`;
    const dbData = await loadDayData(new Date(iso));
    if(dbData) box.innerHTML+=`<div class="preview">${dbData.time}</div>`;
    if(iso===selected.toISOString().slice(0,10)) box.classList.add("selected");
    box.onclick = ()=>selectDate(new Date(iso));
    calendar.appendChild(box);
  }
}

// ì´ë²¤íŠ¸
breakCheck.onclick = ()=> {
  breakWrap.style.display = breakCheck.checked ? "block":"none";
  if(!breakCheck.checked) breakInput.value="";
};

saveBtn.onclick = async ()=>{
  const iso = selected.toISOString().slice(0,10);
  const s = parse(startInput.value);
  const e = parse(endInput.value);
  const b = parse(breakInput.value);
  if(e < s) return alert("í‡´ê·¼ì´ ì¶œê·¼ë³´ë‹¤ ë¹ ë¥¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
  const total = e-s-b;

  await setDoc(doc(db,"worklog",iso),{
    start: startInput.value,
    end: endInput.value,
    break: breakCheck.checked ? breakInput.value : "",
    memo: memoInput.value.trim(),
    time: format(total),
    sec: total
  });

  alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
  renderCalendar();
  renderSelected();
  calcMonthTotal();
};

function calcMonthTotal(){
  const y=current.getFullYear();
  const m=current.getMonth()+1;
  let sum=0;
  getDocs(collection(db,"worklog")).then(snapshot=>{
    snapshot.forEach(doc=>{
      if(doc.id.startsWith(`${y}-${pad(m)}`)){
        sum += doc.data().sec || 0;
      }
    });
    monthTotal.textContent=format(sum);
  });
}

// ì›” ì´ë™
document.getElementById("prevMonth").onclick=()=>{
  current.setMonth(current.getMonth()-1);
  renderCalendar();
  calcMonthTotal();
};
document.getElementById("nextMonth").onclick=()=>{
  current.setMonth(current.getMonth()+1);
  renderCalendar();
  calcMonthTotal();
};

// ğŸ”¹ ë¡œê·¸ì¸ í™•ì¸ í›„ Firestore ì ‘ê·¼
onAuthStateChanged(auth, user=>{
  if(user){
    console.log("ë¡œê·¸ì¸ ì„±ê³µ:", user.email);
    selectDate(new Date());
    calcMonthTotal();
  } else {
    console.log("ë¡œê·¸ì¸ ì•ˆë¨, login.htmlë¡œ ì´ë™");
    location.href = "login.html";
  }
});
</script>
</body>
</html>
